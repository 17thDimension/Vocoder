<!DOCTYPE html>
<html lang="en">
<head>
<title>Vocoder</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<!-- <link rel="shortcut icon" href="Speaker.ico"> -->

<style>
.panel {
   width: 100%;
   border: 1px solid black;
   height: 145px;
}
.hover {
	border: 5px solid red;
}
.notready .sndurl { color: red }
canvas { aborder: 1px solid blue}
</style>

<!-- Analyser Node library -->
<script type="text/javascript" src="analyser.js"></script>

<script type="text/javascript">
var audioContext = null;
var modulatorBuffer = null;
var carrierBuffer = null;
var modulatorNode = null;
var carrierNode = null;

function play() {
	modulatorNode = audioContext.createBufferSource();
	modulatorNode.buffer = modulatorBuffer;
	
	if (!modulatorAnalyser) {
	 	modulatorAnalyser = audioContext.createAnalyser();
		modulatorAnalyser.fftSize = 2048;
		modulatorAnalyser.smoothingTimeConstant = 0.0;
		var gain = audioContext.createGainNode();

		// Initial gain value of modulator (speech) signal
		// change to mute this eventually - still have to connect it to have it play
		gain.gain.value = 0.0;	
		modulatorAnalyser.connect( gain );
		gain.connect( audioContext.destination);
	}
	
	modulatorNode.connect( modulatorAnalyser );
	
	carrierNode = audioContext.createBufferSource();
	carrierNode.buffer = carrierBuffer;
	carrierNode.loop = true;
	carrierNode.gain.value = 0.2;

	if (!carrierAnalyser) {
	 	carrierAnalyser = audioContext.createAnalyser();
		carrierAnalyser.fftSize = 512;
		carrierAnalyser.smoothingTimeConstant = 0.0;
		var gain = audioContext.createGainNode();
		gain.gain.value = 0.0;	// mute it - still have to connect it to have it play
		carrierAnalyser.connect( gain );
		gain.connect( audioContext.destination);
	}

	initBandpassFilters();
	
	carrierNode.connect( carrierAnalyser );
	
	modulatorNode.noteOn(0);
	carrierNode.noteOn(0);

	//turn off the carrier loop when the modulator is done playing
	carrierNode.noteOff(modulatorNode.buffer.duration); 

  	window.webkitRequestAnimationFrame( updateAnalysers );
	window.setTimeout( cancelVocoderUpdates, modulatorNode.buffer.duration * 1000 );
	updateVocoderGainNodes();
}

function loadModulator( buffer ) {
	modulatorBuffer = buffer;
	var e = document.getElementById("modulator");
	e.classList.remove("notready");  
	e.classList.add("ready");
}

function loadCarrier( buffer ) {
	carrierBuffer = buffer;
	var e = document.getElementById("carrier");
	e.classList.remove("notready");  
	e.classList.add("ready");
}

function downloadAudioFromURL( url, cb ){
	var request = new XMLHttpRequest();
  	request.open('GET', url, true);
  	request.responseType = 'arraybuffer';

  	// Decode asynchronously
  	request.onload = function() {
    	audioContext.decodeAudioData( request.response, function(buffer) {
      		cb(buffer);
    	}, function(){alert("error loading!");});
  	}
  	request.send();
}

function startLoadingModulator( url ) {
	modulatorBuffer = null;
	var e = document.getElementById("modurl");
	e.innerHTML = '"' + url + '"';
	e = document.getElementById("modulator");
	e.classList.remove("ready");  
	e.classList.add("notready");
	downloadAudioFromURL( url, loadModulator );
}

function startLoadingCarrier( url ) {
	carrierBuffer = null;
	var e = document.getElementById("carurl");
	e.innerHTML = '"' + url + '"';
	e = document.getElementById("carrier");
	e.classList.remove("ready");  
	e.classList.add("notready");
	downloadAudioFromURL( url, loadCarrier );
}

// Set up the page as a drop site for audio files. When an audio file is
// dropped on the page, it will be auto-loaded as an AudioBufferSourceNode.
function initDragDropOfAudioFiles() {
	var mod = document.getElementById("modulator");
	
	mod.ondragenter = function () { this.classList.add("hover"); return false; };
	mod.ondragleave = function () { this.classList.remove("hover"); return false; };
	mod.ondrop = function (e) {
  		this.classList.remove("hover");
  		e.preventDefault();
		modulatorBuffer = null;
		var m = document.getElementById("modurl");
		m.innerHTML = '"' + e.dataTransfer.files[0].name + '"';
		mod.classList.remove("ready");  
		mod.classList.add("notready");

	  	var reader = new FileReader();
	  	reader.onload = function (event) {
	  		audioContext.decodeAudioData( event.target.result, function(buffer) {
	    		loadModulator( buffer );
	  		}, function(){alert("error loading!");} ); 

	  	};
	  	reader.onerror = function (event) {
	  		alert("Error: " + reader.error );
		};
	  	reader.readAsArrayBuffer(e.dataTransfer.files[0]);
	  	return false;
	};	
	var car = document.getElementById("carrier");
	
	car.ondragenter = function () { this.classList.add("hover"); return false; };
	car.ondragleave = function () { this.classList.remove("hover"); return false; };
	car.ondrop = function (e) {
  		this.classList.remove("hover");
  		e.preventDefault();
		carrierBuffer = null;
		var c = document.getElementById("carurl");
		c.innerHTML = '"' + e.dataTransfer.files[0].name + '"';
		car.classList.remove("ready");  
		car.classList.add("notready");

	  	var reader = new FileReader();
	  	reader.onload = function (event) {
	  		audioContext.decodeAudioData( event.target.result, function(buffer) {
	    		loadCarrier( buffer );
	  		}, function(){alert("error loading!");} ); 

	  	};
	  	reader.onerror = function (event) {
	  		alert("Error: " + reader.error );
		};
	  	reader.readAsArrayBuffer(e.dataTransfer.files[0]);
	  	return false;
	};	
}

// Initialization function for the page.
function init() {
  	try {
    	audioContext = new webkitAudioContext();
  	}
  	catch(e) {
    	alert('Web Audio API is not supported in this browser');
  	}

	initDragDropOfAudioFiles();	// set up panels as drop sites for audio files

	modulatorCanvas = document.getElementById("mcanvas").getContext('2d');
	carrierCanvas = document.getElementById("ccanvas").getContext('2d');
	outputCanvas = document.getElementById("ocanvas").getContext('2d');
	vocoderCanvas = document.getElementById("vcanvas").getContext('2d');

	startLoadingModulator( "RightTrack.ogg" );
	startLoadingCarrier( "Saw.ogg" );
}

window.addEventListener('load', init, false);

</script>
<style>

</style>
</head>

<body>
	<div class="panel notready" id="modulator">
		<div class="headertext">Modulator: <span class="sndurl" id="modurl">No modulator file loaded.</span><button onclick="play();">Play</button></div>
		<canvas id="mcanvas" width=600 height=120></canvas>
	</div>
	<div class="panel notready" id="carrier">
		<div class="headertext">Carrier: <span class="sndurl" id="carurl">No carrier file loaded.</span></div>
		<canvas id="ccanvas" width=600 height=120></canvas>
	</div>
	<div class="panel" id="output">
		<div class="headertext">Output</div>
		<canvas id="ocanvas" width=600 height=120></canvas>
	</div>
	<div class="panel" id="vocoder">
		<div class="headertext">Vocoder Bands</div>
		<canvas id="vcanvas" width=600 height=120></canvas>
	</div>
	
<!--
	<button onclick="var uri=prompt('Enter a URL to a sound file'); if (uri) downloadAudioFromURL(uri); ">AudioBufferSource from URL</button>
	<button onclick="downloadAudioFromURL('440Hz.ogg'); ">Sine Wave AudioBufferSource</button>
<button onclick="var uri=prompt('Enter a URL to an impulse file'); if (uri) downloadImpulseFromURL(uri); ">Convolver from impulse file URL</button>
-->

</div>

</body>
</html>
