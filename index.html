<!DOCTYPE html>
<html lang="en">
<head>
<title>Vocoder</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<!-- <link rel="shortcut icon" href="Speaker.ico"> -->

<style>
.panel {
   width: 100%;
   border: 1px solid black;
   aheight: 145px;
}
.hover {
	border: 5px solid red;
}
.notready .sndurl { color: red }
canvas { aborder: 1px solid blue}
div.overlay { position: absolute; z-index: 10;}
</style>

<!-- Analyser Node library -->
<script type="text/javascript" src="analyser.js"></script>

<!-- WaveShaper library -->
<script type="text/javascript" src="waveshaper.js"></script>

<!-- Debug visualizer stuff begin -->
<!-- Visualizer stuff -->
<script type="text/javascript" src="./Visualizer_files/events.js"></script>

<!-- WebGL stuff -->
<script src="./Visualizer_files/base.js"></script>
<script src="./Visualizer_files/cameracontroller.js"></script>

<!-- TODO(kbr): remove this dependency -->
<script src="./Visualizer_files/matrix4x4.js"></script>

<!-- Visualizer GL library -->
<script type="text/javascript" src="./Visualizer_files/visualizer.js"></script>
<script type="text/javascript" src="./Visualizer_files/shader.js"></script>
<!--  Debug visualizer stuff end -->

<script type="text/javascript">
var audioContext = null;
var modulatorBuffer = null;
var carrierBuffer = null;
var modulatorNode = null;
var carrierNode = null;
var vocoding = false;


// Debug visualizer stuff here
var analyser1;
var analyser2;
var analyserView1;
var analyserView2;

o3djs.require('o3djs.shader');


function playModulatorOnly() {
	clearSliders();
	modulatorNode = audioContext.createBufferSource();
	modulatorNode.buffer = modulatorBuffer;
	
	vocoding = false;
 	modulatorAnalyser = audioContext.createAnalyser();
	modulatorAnalyser.fftSize = 2048;
	modulatorAnalyser.smoothingTimeConstant = 0.0;

		modulatorAnalyser.connect( audioContext.destination);
//	}
	
	modulatorNode.connect( modulatorAnalyser );
	
	modulatorNode.noteOn(0);
  	window.webkitRequestAnimationFrame( updateAnalysers );
	window.setTimeout( cancelVocoderUpdates, modulatorNode.buffer.duration * 1000 + 20 );
}

function stop() {
	clearSliders();
	if (modulatorNode)
		modulatorNode.noteOff(0);
	if (vocoding) {
		carrierNode.noteOff(0);
		vocoding = false;
	}
	window.webkitCancelAnimationFrame( rafID );
}

// This is used as a muted output node - right now, analysers and other nodes need to be connected.
var zerogain = null;

function updateSingleGain( event ) {
	var t = event.target;
	var value = t.value;
	t.audioNode.gain.value = value;

	//update the numeric display
	t.parentNode.childNodes[2].textContent = value;
}

function updateSingleFrequency( event ) {
	var t = event.target;
	var value = t.value;
	t.audioNode.frequency.value = value;

	//update the numeric display
	t.parentNode.childNodes[2].textContent = value;
}

function updateSingleQ( event ) {
	var t = event.target;
	var value = t.value;
	t.audioNode.Q.value = value;

	//update the numeric display
	t.parentNode.childNodes[2].textContent = value;
}

function updateGains( event ) {
	var t = event.target;
	var value = t.value;
	for (var i=0; i<numVocoderBands; i++)
		t.audioNodes[i].gain.value = value;

	//update the numeric display
	t.parentNode.childNodes[2].textContent = value;
}

function updateQs( event ) {
	var t = event.target;
	var value = t.value;
	for (var i=0; i<numVocoderBands; i++)
		t.audioNodes[i].Q.value = value;

	//update the numeric display
	t.parentNode.childNodes[2].textContent = value;
}


function setupVocoderGraph() {
	clearSliders();
	modulatorNode = audioContext.createBufferSource();
	modulatorNode.buffer = modulatorBuffer;
	
	vocoding = true;

 	modulatorAnalyser = audioContext.createAnalyser();
	modulatorAnalyser.fftSize = 2048;
	modulatorAnalyser.smoothingTimeConstant = 0.0;
	modulatorAnalyser.connect( zerogain );

	var modulatorPreAnalyserGain = audioContext.createGainNode();
	modulatorPreAnalyserGain.gain.value = 0.15;
	modulatorPreAnalyserGain.connect( modulatorAnalyser);
	modulatorNode.connect( modulatorPreAnalyserGain );
	
	carrierNode = audioContext.createBufferSource();
	carrierNode.buffer = carrierBuffer;
	carrierNode.loop = true;
	carrierNode.gain.value = 1.0;

 	carrierAnalyser = audioContext.createAnalyser();
	carrierAnalyser.fftSize = 2048;
	carrierAnalyser.smoothingTimeConstant = 0.0;
	carrierAnalyser.connect( zerogain );

	var carrierPreAnalyserGain = audioContext.createGainNode();
	carrierPreAnalyserGain.gain.value = 0.1;
	carrierNode.connect( carrierPreAnalyserGain );
	carrierPreAnalyserGain.connect( carrierAnalyser);

 	outputAnalyser = audioContext.createAnalyser();
	outputAnalyser.fftSize = 2048;
	outputAnalyser.smoothingTimeConstant = 0.0;
	outputAnalyser.connect( zerogain );

	initBandpassFilters();
	
//	carrierNode.connect( carrierAnalyser );
}

function play() {
	
	modulatorNode.noteOn(0);
	carrierNode.noteOn(0);

	//turn off the carrier loop when the modulator is done playing
	carrierNode.noteOff(modulatorNode.buffer.duration); 

  	window.webkitRequestAnimationFrame( updateAnalysers );
	window.setTimeout( cancelVocoderUpdates, modulatorNode.buffer.duration * 1000 + 20 );
//	updateVocoderGainNodes();
}

function loadModulator( buffer ) {
	modulatorBuffer = buffer;
	var e = document.getElementById("modulator");
	e.classList.remove("notready");  
	e.classList.add("ready");

	if ( !document.getElementById("carrier").classList.contains("notready") )
		ready();
}

function loadCarrier( buffer ) {
	carrierBuffer = buffer;
	var e = document.getElementById("carrier");
	e.classList.remove("notready");  
	e.classList.add("ready");

	if ( !document.getElementById("modulator").classList.contains("notready") )
		ready();
}

function downloadAudioFromURL( url, cb ){
	var request = new XMLHttpRequest();
  	request.open('GET', url, true);
  	request.responseType = 'arraybuffer';

  	// Decode asynchronously
  	request.onload = function() {
    	audioContext.decodeAudioData( request.response, function(buffer) {
      		cb(buffer);
    	}, function(){alert("error loading!");});
  	}
  	request.send();
}

function startLoadingModulator( url ) {
	modulatorBuffer = null;
	var e = document.getElementById("modurl");
	e.innerHTML = '"' + url + '"';
	e = document.getElementById("modulator");
	e.classList.remove("ready");  
	e.classList.add("notready");
	downloadAudioFromURL( url, loadModulator );
}

function startLoadingCarrier( url ) {
	carrierBuffer = null;
	var e = document.getElementById("carurl");
	e.innerHTML = '"' + url + '"';
	e = document.getElementById("carrier");
	e.classList.remove("ready");  
	e.classList.add("notready");
	downloadAudioFromURL( url, loadCarrier );
}

// Set up the page as a drop site for audio files. When an audio file is
// dropped on the page, it will be auto-loaded as an AudioBufferSourceNode.
function initDragDropOfAudioFiles() {
	var mod = document.getElementById("modulator");
	
	mod.ondragenter = function () { this.classList.add("hover"); return false; };
	mod.ondragleave = function () { this.classList.remove("hover"); return false; };
	mod.ondrop = function (e) {
  		this.classList.remove("hover");
  		e.preventDefault();
		modulatorBuffer = null;
		var m = document.getElementById("modurl");
		m.innerHTML = '"' + e.dataTransfer.files[0].name + '"';
		mod.classList.remove("ready");  
		mod.classList.add("notready");

	  	var reader = new FileReader();
	  	reader.onload = function (event) {
	  		audioContext.decodeAudioData( event.target.result, function(buffer) {
	    		loadModulator( buffer );
	  		}, function(){alert("error loading!");} ); 

	  	};
	  	reader.onerror = function (event) {
	  		alert("Error: " + reader.error );
		};
	  	reader.readAsArrayBuffer(e.dataTransfer.files[0]);
	  	return false;
	};	
	var car = document.getElementById("carrier");
	
	car.ondragenter = function () { this.classList.add("hover"); return false; };
	car.ondragleave = function () { this.classList.remove("hover"); return false; };
	car.ondrop = function (e) {
  		this.classList.remove("hover");
  		e.preventDefault();
		carrierBuffer = null;
		var c = document.getElementById("carurl");
		c.innerHTML = '"' + e.dataTransfer.files[0].name + '"';
		car.classList.remove("ready");  
		car.classList.add("notready");

	  	var reader = new FileReader();
	  	reader.onload = function (event) {
	  		audioContext.decodeAudioData( event.target.result, function(buffer) {
	    		loadCarrier( buffer );
	  		}, function(){alert("error loading!");} ); 

	  	};
	  	reader.onerror = function (event) {
	  		alert("Error: " + reader.error );
		};
	  	reader.readAsArrayBuffer(e.dataTransfer.files[0]);
	  	return false;
	};	
}

function clearSliders() {
	var sliders = document.getElementById("sliders");
	var child;

	for (child=sliders.firstChild; child; child=sliders.firstChild)
		sliders.removeChild( child );
}

function addSlider( label, defaultValue, minValue, maxValue, nodeArray, onChange ) {
	// insert a range control
	// <input type="range" id="rangeEl" value="0.5" oninput="alert(this.value);" min="0.0" max="1.0" step="0.01">
	var div = document.createElement("div");
	div.appendChild(document.createTextNode(label));
	var ctl = document.createElement("input");
	ctl.type = "range";
	ctl.min = minValue;
	ctl.max = maxValue;
	ctl.step = (maxValue - minValue) / 1000.0;
	ctl.value = defaultValue;
	ctl.oninput = onChange;
	ctl.audioNodes = nodeArray;
	ctl.label = label;
	div.appendChild(ctl);
	div.appendChild(document.createTextNode(defaultValue));
	document.getElementById("sliders").appendChild(div);
}

function addSingleValueSlider( label, defaultValue, minValue, maxValue, node, onChange ) {
	// insert a range control
	// <input type="range" id="rangeEl" value="0.5" oninput="alert(this.value);" min="0.0" max="1.0" step="0.01">
	var div = document.createElement("div");
	div.appendChild(document.createTextNode(label));
	var ctl = document.createElement("input");
	ctl.type = "range";
	ctl.min = minValue;
	ctl.max = maxValue;
	ctl.step = (maxValue - minValue) / 1000.0;
	ctl.value = defaultValue;
	ctl.oninput = onChange;
	ctl.audioNode = node;
	ctl.label = label;
	div.appendChild(ctl);
	div.appendChild(document.createTextNode(defaultValue));
	document.getElementById("sliders").appendChild(div);
}

function ready() {
	setupVocoderGraph();
}

// Initialization function for the page.
function init() {
  	try {
    	audioContext = new webkitAudioContext();
  	}
  	catch(e) {
    	alert('Web Audio API is not supported in this browser');
  	}

	initDragDropOfAudioFiles();	// set up panels as drop sites for audio files

	modulatorCanvas = document.getElementById("mcanvas").getContext('2d');
	carrierCanvas = document.getElementById("ccanvas").getContext('2d');
	outputCanvas = document.getElementById("ocanvas").getContext('2d');
	vocoderCanvas = document.getElementById("vcanvas").getContext('2d');

//	startLoadingModulator( "RightTrack.ogg" );
//	startLoadingModulator( "human-voice.mp4" );
	startLoadingModulator( "fightclub.ogg" );
//	startLoadingCarrier( "sawz2.ogg" );
	startLoadingCarrier( "Noise.ogg" );
//	startLoadingCarrier( "Saw.ogg" );

	// set up the zero gain node
	zerogain = audioContext.createGainNode();
	zerogain.gain.value = 0.0;	
	zerogain.connect( audioContext.destination);
 
	// Debug visualizer
    analyser1 = audioContext.createAnalyser();
    analyser1.fftSize = 2048;
    analyser2 = audioContext.createAnalyser();
    analyser2.fftSize = 2048;

    // Connect the analysers to a zeroed gain node so it will play
    analyser1.connect( zerogain );
    analyser2.connect( zerogain );

    analyserView1 = new AnalyserView("view1", "overlay1");
    analyserView1.initByteBuffer( analyser1 );
    analyserView2 = new AnalyserView("view2", "overlay2");
    analyserView2.initByteBuffer( analyser2 );
}

function keyevent( event ) {
	if (event)
		return;
}

window.onload=init;
window.onkeydown=keyevent();

</script>








<style>

</style>
</head>

<body>
	<div id="sliders"></div>
	<div class="panel notready" id="modulator">
		<div class="headertext">Modulator: <span class="sndurl" id="modurl">No modulator file loaded.</span>
			<button onclick="play();">Vocode</button>
			<button onclick="playModulatorOnly();">Play source</button>
			<button onclick="stop();">Stop</button>
		</div>
		<canvas id="mcanvas" style="display:none" width=1200 height=120></canvas>
	</div>
	<div class="panel notready" id="carrier">
		<div class="headertext">Carrier: <span class="sndurl" id="carurl">No carrier file loaded.</span><button onclick="startLoadingCarrier( 'Saw.ogg' );">Sawtooth</button><button onclick="startLoadingCarrier( 'Noise.ogg' );">Noise</button></div>
		<canvas id="ccanvas" style="display:none" width=1200 height=120></canvas>
	<div class="panel" id="output">
		<div class="headertext">Output</div>
		<canvas id="ocanvas" style="display:none" width=1200 height=120></canvas>
	</div>
	<div class="panel" id="vocoder" >
		<div class="headertext">Vocoder Bands</div>
		<canvas id="vcanvas" width=1200 height=120></canvas>
	</div>


	<!-- Debugging analyser -->
<div id="controls">
<!-- Analyser type -->
<input type="radio" name="radioSet" value="data" 
	onmousedown="analyserView1.setAnalysisType(ANALYSISTYPE_FREQUENCY); analyserView2.setAnalysisType(ANALYSISTYPE_FREQUENCY);">Frequency
<input type="radio" name="radioSet" value="data" 
	onmousedown="analyserView1.setAnalysisType(ANALYSISTYPE_SONOGRAM); analyserView2.setAnalysisType(ANALYSISTYPE_SONOGRAM);">Sonogram
<input type="radio" name="radioSet" value="data" checked="checked" 
	onmousedown="analyserView1.setAnalysisType(ANALYSISTYPE_3D_SONOGRAM); analyserView2.setAnalysisType(ANALYSISTYPE_3D_SONOGRAM);">3D Sonogram
<input type="radio" name="radioSet" value="data" 
	onmousedown="analyserView1.setAnalysisType(ANALYSISTYPE_WAVEFORM); analyserView2.setAnalysisType(ANALYSISTYPE_WAVEFORM);">Waveform
<select onselect="alert('select:' + this.target.value);">
	<option value="0">0</option>
	<option value="1">1</option>
	<option value="2">2</option>
	<option value="3">3</option>
	<option value="4">4</option>
	<option value="5">5</option>
	<option value="6">6</option>
	<option value="7">7</option>
	<option value="8">8</option>
	<option value="9">9</option>
	<option value="10">10</option>
	<option value="11">11</option>
	<option value="12">12</option>
	<option value="13">13</option>
	<option value="14">14</option>
	<option value="15">15</option>
</select>
</div>
<!-- Canvas tag for WebGL output -->
<div class="overlay" id="overlay1"></div><canvas id="view1" width="1280px" height="200px"></canvas>
<div class="overlay" id="overlay2"></div><canvas id="view2" width="1280px" height="200px"></canvas>


	</div>

</div>

</body>
</html>
